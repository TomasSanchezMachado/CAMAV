{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-3">Operarios</h1>

  <!-- Buscador + Botones -->
  <div class="d-flex align-items-center mb-4">
    <!-- Buscador (50% del ancho) -->
    <form method="get" class="d-flex flex-grow-1" style="max-width: 50%;">
      <div class="input-group w-100">
        <input
          type="text"
          name="q"
          class="form-control"
          placeholder="Buscar por nombre, apellido o legajo..."
          value="{{ request.GET.q }}"
        >
        <button class="btn btn-primary" type="submit">Buscar</button>
      </div>
    </form>

    <div class="d-flex ms-3 gap-2">
      <button type="button" class="btn btn-success" onclick="window.location.href='/crear_operario'">
        Agregar</button>
      <button id="btnEliminar" type="button" class="btn btn-secondary" disabled>
        Eliminar
      </button>
    </div>
  </div>

  {% if operarios %}
    <!-- Form que envía los IDs seleccionados para eliminar -->
    <form id="operariosForm" method="post" action="/operarios/eliminar/">
      {% csrf_token %}

      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle mb-0">
          <thead>
            <tr>
              <th style="width:42px;">
                <!-- (opcional) checkbox maestro -->
                <input type="checkbox" id="checkAll">
              </th>
              <th>Legajo</th>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Tareas pendientes</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            {% for op in operarios %}
              <tr>
                <td>
                  <input
                    type="checkbox"
                    class="op-check"
                    name="selected_ids"
                    value="{{ op.id }}"
                  >
                </td>
                <td class="editable" data-id="{{ op.id }}" data-field="legajo">{{ op.legajo }}</td>
                <td class="editable" data-id="{{ op.id }}" data-field="nombre">{{ op.nombre }}</td>
                <td class="editable" data-id="{{ op.id }}" data-field="apellido">{{ op.apellido }}</td>
                <td>{{ op.pendientes_count }}</td>
                {%if op.estado == 'Libre' %}
                  <td class="text-success fw-bold">{{ op.estado }}</td>
                {% else %}
                  <td class="text-danger fw-bold">Realizando tarea nro {{ op.estado }}</td>
                {% endif %}
                
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  {% else %}
    <div class="alert alert-info mt-3">No hay operarios para mostrar.</div>
  {% endif %}
</div>

<!-- JS para eliminación -->
<script>
  (function() {
    const btnEliminar = document.getElementById('btnEliminar');
    const form = document.getElementById('operariosForm');
    const checks = document.querySelectorAll('.op-check');
    const checkAll = document.getElementById('checkAll');

    function anyChecked() {
      return document.querySelectorAll('.op-check:checked').length > 0;
    }

    function updateDeleteButton() {
      if (!btnEliminar) return;
      if (anyChecked()) {
        btnEliminar.disabled = false;
        btnEliminar.classList.remove('btn-secondary');
        btnEliminar.classList.add('btn-danger');
      } else {
        btnEliminar.disabled = true;
        btnEliminar.classList.remove('btn-danger');
        btnEliminar.classList.add('btn-secondary');
      }
    }

    // Eventos checkbox
    checks.forEach(ch => ch.addEventListener('change', updateDeleteButton));
    updateDeleteButton();

    // Checkbox todos
    if (checkAll) {
      checkAll.addEventListener('change', function() {
        checks.forEach(ch => ch.checked = checkAll.checked);
        updateDeleteButton();
      });
    }

    // Confirmación de Eliminar
    if (btnEliminar) {
      btnEliminar.addEventListener('click', function() {
        const count = document.querySelectorAll('.op-check:checked').length;
        if (count === 0) return;

        const ok = confirm(`¿Eliminar ${count} operario(s)? Esta acción no se puede deshacer.`);
        if (ok && form) form.submit();
      });
    }
  })();
</script>

<!-- JS para edición de operarios -->
<script>
  (function() {
    // --- CSRF helper ---
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      if (match) return decodeURIComponent(match[2]);
      return null;
    }
    const csrftoken = getCookie('csrftoken');

    const makeEditable = (td) => {
      if (td.dataset.editing === '1') return; // evitar doble edición
      td.dataset.editing = '1';

      const originalText = td.textContent.trim();
      const field = td.dataset.field;  
      const id = td.dataset.id;

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control form-control-sm';
      input.value = originalText;

      // Ajuste visual: mantener ancho de la celda
      td.textContent = '';
      td.appendChild(input);
      input.focus();
      input.select();

      const cancel = () => {
        td.textContent = originalText;
        td.dataset.editing = '0';
      };

      const save = async (newVal) => {
        try {
          const resp = await fetch("/operarios/actualizar/", {
            method: "POST",
            headers: {
              "X-CSRFToken": csrftoken,
            },
            body: new URLSearchParams({
              id: id,
              field: field,
              value: newVal
            })
          });

          if (!resp.ok) throw new Error("Error HTTP " + resp.status);
          const data = await resp.json();
          if (data.ok) {
            td.textContent = data.value;
          } else {
            td.textContent = originalText; // rollback
            alert(data.error || "No se pudo actualizar.");
          }
        } catch (e) {
          td.textContent = originalText; // rollback
          alert("Error al actualizar: " + e.message);
        } finally {
          td.dataset.editing = '0';
        }
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const newVal = input.value.trim();
          if (newVal === originalText) { cancel(); return; }
          save(newVal);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancel();
        } // cualquier otra tecla: no guarda
      });

      // Si pierde foco y no se presionó Enter, cancelar
      input.addEventListener('blur', cancel);
    };

    // Activar con doble click
    document.querySelectorAll('td.editable').forEach(td => {
      td.addEventListener('dblclick', () => makeEditable(td));
    });
  })();
</script>


{% endblock %}
